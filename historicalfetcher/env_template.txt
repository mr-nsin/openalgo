# OpenAlgo Historical Data Fetcher Environment Configuration
# This template shows the required environment variables for the historical data fetcher

# ============================================================================
# OPENALGO API CONFIGURATION (REQUIRED)
# ============================================================================
# These are the primary credentials needed to authenticate with OpenAlgo
# The historical fetcher uses OpenAlgo's API layer, NOT direct broker APIs

# OpenAlgo API Key - Generated from OpenAlgo web interface
# This key is used to authenticate with OpenAlgo and fetch historical data
# through OpenAlgo's unified API layer
OPENALGO_API_KEY=your_openalgo_api_key_here

# OpenAlgo API Host - URL where your OpenAlgo instance is running
OPENALGO_API_HOST=http://127.0.0.1:5000

# OpenAlgo Database URL - Connection to OpenAlgo's symbol database
# This should match your main OpenAlgo DATABASE_URL setting
DATABASE_URL=sqlite:///db/openalgo.db

# ============================================================================
# QUESTDB CONFIGURATION (HISTORICAL DATA STORAGE)
# ============================================================================
# QuestDB is used to store the fetched historical data for fast time-series queries

HIST_FETCHER_QUESTDB_HOST=localhost
HIST_FETCHER_QUESTDB_PORT=9000
HIST_FETCHER_QUESTDB_USERNAME=
HIST_FETCHER_QUESTDB_PASSWORD=
HIST_FETCHER_QUESTDB_DATABASE=qdb

# ============================================================================
# DATA FETCHING CONFIGURATION
# ============================================================================
# Configure what data to fetch and how to fetch it

# Timeframes to fetch (comma-separated)
# Supported: 1m, 3m, 5m, 15m, 30m, 1h, D
HIST_FETCHER_ENABLED_TIMEFRAMES=1m,3m,5m,15m,30m,1h,D

# Instrument types to fetch (comma-separated)
# Database instrument types that will be mapped to fetcher types:
#   Options: OPTSTK, OPTIDX, OPTCUR, OPTIRC, OPTBLN, OPTFUT -> CE/PE
#   Futures: FUTSTK, FUTIDX, FUTCUR, FUTIRC, FUTIRT, FUTCOM, FUTBAS, FUTBLN, FUTENR -> FUT
#   Equities: EQ, UNDIRC, UNDCUR, UNDIRT, UNDIRD, COMDTY -> EQ
#   Index: INDEX, AMXIDX -> INDEX
# You can specify either database types or fetcher types (CE, PE, FUT, EQ, INDEX)
# Recommended: Include all database types you want to fetch
HIST_FETCHER_ENABLED_INSTRUMENT_TYPES=OPTSTK,OPTIDX,FUTSTK,FUTIDX,OPTCUR,OPTIRC,FUTCUR,FUTIRC,FUTIRT,UNDIRC,UNDCUR,INDEX,UNDIRT,UNDIRD,COMDTY,FUTCOM,OPTFUT,OPTBLN,FUTBAS,FUTBLN,FUTENR,AMXIDX,EQ

# Exchanges to include (comma-separated)
# IMPORTANT: NSE_INDEX and BSE_INDEX must be included for index symbols (NIFTY, BANKNIFTY, SENSEX, etc.)
# Order: INDEX exchanges first to ensure they are processed first
HIST_FETCHER_ENABLED_EXCHANGES=NSE_INDEX,BSE_INDEX,NSE,BSE,NFO,BFO

# Historical data range (days from today)
# Default: 365 days (1 year) for equities, futures, and indices
HIST_FETCHER_HISTORICAL_DAYS_LIMIT=365

# Options-specific historical data range (days back from today)
# Default: 90 days (3 months) for CE/PE options
# This controls how far back historical data is fetched for options strikes
# Example: If today is 2024-11-28, it will fetch data from 2024-08-30 to 2024-11-28
HIST_FETCHER_OPTIONS_HISTORICAL_DAYS_LIMIT=90

# Options expiry filtering configuration
# Maximum number of nearest expiries to fetch for options (CE/PE)
# Default: 5 (only process options with the 5 nearest expiry dates)
# Example: If today is 2024-11-28 and expiries are [2024-11-28, 2024-12-05, 2024-12-12, 2024-12-19, 2024-12-26, 2025-01-02, ...]
#          Only options with the first 5 expiry dates will be processed
HIST_FETCHER_OPTIONS_MAX_EXPIRIES=5

# Options underlying filtering configuration
# Allowed option underlyings for CE/PE fetching (comma-separated, case-insensitive)
# Default: NIFTY,BANKNIFTY,SENSEX,FINNIFTY (major indices)
# Set to empty string, '*', or 'ALL' to fetch all underlyings (when HIST_FETCHER_OPTIONS_FILTER_BY_UNDERLYING=false)
# Examples:
#   HIST_FETCHER_OPTIONS_ALLOWED_UNDERLYINGS=NIFTY,BANKNIFTY,SENSEX,FINNIFTY  (only these 4)
#   HIST_FETCHER_OPTIONS_ALLOWED_UNDERLYINGS=NIFTY,BANKNIFTY  (only NIFTY and BANKNIFTY)
#   HIST_FETCHER_OPTIONS_ALLOWED_UNDERLYINGS=  (empty - will fetch all if filter is disabled)
HIST_FETCHER_OPTIONS_ALLOWED_UNDERLYINGS=NIFTY,BANKNIFTY,SENSEX,FINNIFTY

# Whether to filter CE/PE options by allowed underlyings
# true: Only fetch CE/PE for underlyings in HIST_FETCHER_OPTIONS_ALLOWED_UNDERLYINGS
# false: Fetch all CE/PE options (ignore HIST_FETCHER_OPTIONS_ALLOWED_UNDERLYINGS)
# Default: true (only fetch specified underlyings)
HIST_FETCHER_OPTIONS_FILTER_BY_UNDERLYING=true

# Optional: Override start date (YYYY-MM-DD format)
# If set, this overrides HISTORICAL_DAYS_LIMIT
HIST_FETCHER_START_DATE_OVERRIDE=

# ============================================================================
# PERFORMANCE CONFIGURATION
# ============================================================================
# Configure processing performance and rate limiting
#
# IMPORTANT: Rate limiting is critical to avoid API throttling and "too many requests" errors
# Zerodha API official limit: 3 requests/second
# Recommended settings: 2 requests/second with 2 concurrent for safety margin
#
# Calculation example:
# - 100 symbols × 5 timeframes = 500 requests
# - At 2 req/sec: 500/2 = 250 seconds (~4 minutes)
# - At 0.2 req/sec: 500/0.2 = 2500 seconds (~42 minutes) ❌ TOO SLOW
# - At 3 req/sec: Risk of hitting rate limits ❌ TOO AGGRESSIVE

# API requests per second (MUST be below Zerodha's 3 req/sec limit)
# Recommended: 2.0 (safe margin below 3.0 limit)
# Minimum: 0.5 (very slow, but safe)
# Maximum: 2.5 (risky, close to limit)
HIST_FETCHER_API_REQUESTS_PER_SECOND=2.0

# Maximum concurrent requests (parallel API calls)
# Recommended: 2 (allows some parallelization without overwhelming)
# Minimum: 1 (very safe, but slower)
# Maximum: 3 (risky with high request rate)
# Note: Higher concurrency × higher rate = more total requests
#       Example: 2 concurrent × 2 req/sec = 4 req/sec effective (exceeds limit!)
#       So keep: (concurrent × rate) < 3.0
HIST_FETCHER_MAX_CONCURRENT_REQUESTS=2

# Batch size for processing symbols (how many symbols to process in parallel)
# Recommended: 50 (good balance between throughput and memory)
# Lower values (10-20): More control, less memory usage
# Higher values (100+): Faster but more memory intensive
HIST_FETCHER_BATCH_SIZE=50

# Memory limit in MB
HIST_FETCHER_MEMORY_LIMIT_MB=4096

# Enable performance monitoring
HIST_FETCHER_ENABLE_PERFORMANCE_MONITORING=true

# ============================================================================
# NOTIFICATION CONFIGURATION (OPTIONAL)
# ============================================================================
# Configure notifications for fetch status updates

# ============================================================================
# TELEGRAM NOTIFICATION CONFIGURATION (OPTIONAL)
# ============================================================================
# Configure Telegram notifications for real-time updates and alerts
# This reuses OpenAlgo's existing Telegram bot configuration

# Telegram Bot Token - Get this from @BotFather on Telegram
# 1. Message @BotFather on Telegram
# 2. Create a new bot with /newbot command
# 3. Copy the bot token provided
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here

# Telegram Chat IDs - List of chat IDs to send notifications to
# Format: Comma-separated list without spaces
# To get your chat ID:
# 1. Message your bot or add it to a group
# 2. Visit: https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates
# 3. Look for "chat":{"id": YOUR_CHAT_ID} in the response
# Examples:
#   Single user: TELEGRAM_CHAT_IDS=123456789
#   Multiple users: TELEGRAM_CHAT_IDS=123456789,987654321
#   Group chat: TELEGRAM_CHAT_IDS=-1001234567890
TELEGRAM_CHAT_IDS=your_chat_id_here

# ============================================================================
# EMAIL NOTIFICATION CONFIGURATION (OPTIONAL)
# ============================================================================
# Configure email notifications for detailed reports and summaries

# Email Configuration (optional)
HIST_FETCHER_SMTP_HOST=smtp.gmail.com
HIST_FETCHER_SMTP_PORT=587
HIST_FETCHER_SMTP_USERNAME=your_email@gmail.com
HIST_FETCHER_SMTP_PASSWORD=your_app_password
HIST_FETCHER_EMAIL_RECIPIENTS=["recipient@example.com"]

# ============================================================================
# NOTIFICATION BEHAVIOR NOTES:
# ============================================================================
# 
# 1. TELEGRAM NOTIFICATIONS:
#    - Real-time progress updates during data fetching
#    - Success/completion notifications with statistics
#    - Error alerts with context and troubleshooting info
#    - Warning notifications for non-critical issues
# 
# 2. EMAIL NOTIFICATIONS:
#    - Detailed summary reports with comprehensive statistics
#    - Error notifications with full stack traces
#    - Final completion reports with data analysis
#    - Less frequent than Telegram to avoid spam
# 
# 3. NOTIFICATION TRIGGERS:
#    - Fetch process start/completion
#    - Errors during data fetching or processing
#    - Database connection issues
#    - API rate limit warnings
#    - Memory/performance alerts
# 
# 4. CONFIGURATION TIPS:
#    - Use Telegram for real-time monitoring
#    - Use Email for detailed reports and record-keeping
#    - Both are optional - the fetcher works without notifications
#    - Test your configuration using the built-in connection test
# 
# 5. TESTING TELEGRAM SETUP:
#    - After configuring, the fetcher will test connections on startup
#    - Send a test message to verify: /start command to your bot
#    - Check logs for "Telegram notifier initialized" message
#    - Ensure your bot has permission to send messages to the chat/group
#
# ============================================================================
# LOGGING CONFIGURATION
# ============================================================================
# Configure logging behavior

HIST_FETCHER_LOG_LEVEL=INFO
HIST_FETCHER_LOG_FILE_PATH=logs/historical_fetcher.log
HIST_FETCHER_LOG_ROTATION=100 MB
HIST_FETCHER_LOG_RETENTION=30 days

# ============================================================================
# IMPORTANT NOTES:
# ============================================================================
# 
# 1. OPENALGO_API_KEY is the ONLY broker credential needed
#    - This key authenticates with OpenAlgo
#    - OpenAlgo handles the actual broker authentication internally
#    - DO NOT add BROKER_API_KEY or BROKER_API_SECRET here
# 
# 2. The historical fetcher works through OpenAlgo's API layer:
#    - Fetcher -> OpenAlgo API -> Broker API -> Historical Data
#    - This ensures consistent authentication and error handling
# 
# 3. Make sure your OpenAlgo instance is running and properly configured
#    with your broker credentials before running the historical fetcher
# 
# 4. Generate your OPENALGO_API_KEY from the OpenAlgo web interface:
#    - Login to OpenAlgo -> Settings -> API Keys -> Generate New Key
#
# 5. Install required dependencies (if not already installed):
#    pip install pydantic-settings
#    # or install all requirements: pip install -r requirements.txt
#
# 6. Copy this template to .env and fill in your actual values:
#    cp env_template.txt .env
#    nano .env
